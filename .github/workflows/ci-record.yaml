name: Fixtures re-recording

on:
  workflow_dispatch:

  # NOTE(sileht): should be in sync with the chunk later.
  schedule:
    - cron: 0 14 * * 1-5

jobs:
  record:
    timeout-minutes: 180
    runs-on: ubuntu-latest
    services:
      redis:
        image: bitnami/redis:latest
        ports:
          - 6363:6379
        env:
          REDIS_EXTRA_FLAGS: --databases 1000
          ALLOW_EMPTY_PASSWORD: yes

      postgres:
        image: ankane/pgvector:v0.4.4
        env:
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: --name postgres
    strategy:
      max-parallel: 2
      fail-fast: false
      matrix:
        target:
          # - {"name": "GitHub.com", "secret_name": "FIXTURES_RECORDER_CONFIG_GITHUB_DOT_COM"}
          # yamllint disable-line rule:quoted-strings
          - {"name": "GitHub Enterprise Server", "secret_name": "FIXTURES_RECORDER_CONFIG_GHES_DEV"}

    steps:
      - name: start google_cloud_storage
        # FIXME(sileht): move this in services when GitHub will support image args
        run: |
          docker pull fsouza/fake-gcs-server
          docker run --rm -d -p 8000:8000 fsouza/fake-gcs-server -backend memory -scheme http -port 8000

      - name: Checkout 🛎️
        uses: actions/checkout@v4

      - name: Setup Python 🔧
        uses: actions/setup-python@v5.0.0
        with:
          python-version: 3.12.1

      - name: Build 🔧 & Test 🔍
        run: |
          cat > test.env << EOF
          ${{ secrets[matrix.target.secret_name] }}
          EOF
          export MERGIFYENGINE_TESTING_RECORD_EVENTS_WAITING_TIME=300
          # nosemgrep: generic.ci.security.use-frozen-lockfile.use-frozen-lockfile-pip
          pip install -r requirements-poetry.txt
          tools/poetry-ci-install.sh
          DOW=$(date +%u)
          poetry run poe record -- --splits 5 --group "${DOW}"

      - name: Report Status
        if: always()
        # yamllint disable-line rule:line-length
        # nosemgrep: yaml.github-actions.security.third-party-action-not-pinned-to-commit-sha.third-party-action-not-pinned-to-commit-sha
        uses: Mergifyio/gha-slack-notification@main
        with:
          message: ${{ matrix.target.name }}, engine fixture re-generation tests
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WORKFLOWS_WEBHOOK_URL }}
