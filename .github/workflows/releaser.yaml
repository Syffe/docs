# Release command:
#
#  gh workflow run Releaser
#
name: Releaser
permissions: write-all
on:
  workflow_dispatch:
    inputs:
      publish_release:
        description: "set to `true` to publish the release"
        required: false
        default: false
jobs:
  releaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          token: "${{ secrets.MERGIFY_CI_BOT_PAT }}"
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python ğŸ”§
        uses: actions/setup-python@v4.7.0
        with:
          python-version: 3.11.4

      - name: Setup dependencies ğŸ”§
        run: |
          set -e
          set -o pipefail

          pip install reno

          curl -L https://github.com/jgm/pandoc/releases/download/2.14.2/pandoc-2.14.2-linux-amd64.tar.gz \
            | tar -xzf - --strip-components=2 pandoc-2.14.2/bin/pandoc

      - name: Build release notes ğŸ“
        id: relnote
        run: |
          set -e
          set -x
          set -o pipefail

          git fetch --tag
          VERSION=$(reno -q semver-next)

          echo "âœ‚â”…â”…â”…"
          reno -q report --title '' --no-show-source | ./pandoc -t markdown | sed -e '/^\.\./,+1d' -e '1,4d'
          echo "âœ‚â”…â”…â”…"

          git tag "${VERSION}"
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Push git tag ğŸï¸
        if: ${{ github.event.inputs.publish_release }}
        run: |
          set -e
          set -x
          set -o pipefail
          git push origin ${{ steps.relnote.outputs.VERSION }}
