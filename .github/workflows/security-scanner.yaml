name: Scan docker image
permissions: read-all

# NOTE(sileht): we use on premise image for pull request tests
on:
  workflow_dispatch:
  schedule:
    - cron: 0 0 * * *
  pull_request:
    branches:
      - main
      - devs/**
    paths:
      - .github/workflows/security-scanner.yml

concurrency:
  # yamllint disable-line rule:line-length
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docker-image-security-scan:
    timeout-minutes: 10
    runs-on: ubuntu-22.04
    steps:
      - name: ðŸ‘® Log into in Heroku
        if: github.event_name != 'pull_request'
        run: |
          cat >~/.netrc <<EOF
          machine api.heroku.com
              login prod+heroku@mergify.com
              password ${{secrets.HEROKU_API_KEY}}
          machine git.heroku.com
              login prod+heroku@mergify.com
              password ${{secrets.HEROKU_API_KEY}}
          EOF
          heroku container:login

      - name: â˜ï¸  Download latest image
        id: download-image
        run: |
          if [[ ${{ github.event_name }} == 'pull_request' ]]; then
            image=mergifyio/engine:latest
          else
            image=registry.heroku.com/mergify-engine/web:latest
          fi
          docker pull $image
          echo "image-ref=$image" >> "$GITHUB_OUTPUT"

      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        # yamllint disable-line rule:line-length
        # nosemgrep: yaml.github-actions.security.third-party-action-not-pinned-to-commit-sha.third-party-action-not-pinned-to-commit-sha
        uses: aquasecurity/trivy-action@0.16.1
        with:
          image-ref: ${{ steps.download-image.outputs.image-ref }}
          format: json
          scanners: vuln
          output: docker-security-scan.json.tmp

      - uses: ./.github/actions/tooling-setup
        with:
          github_token: ${{ secrets.MERGIFY_CI_BOT_PAT }}

      - name: Keep only the results section
        if: github.event_name != 'pull_request'
        id: update
        # yamllint disable rule:line-length
        run: |
          jq --raw-output '.Results[0].Vulnerabilities' docker-security-scan.json.tmp > docker-security-scan.json.new

          ${{ runner.temp }}/tooling/docker-security-reporter.py docker-security-scan.json docker-security-scan.json.new >> "$GITHUB_OUTPUT"

          rm -f docker-security-scan.json.tmp
          rm -f docker-security-scan.json.new
        # yamllint enable rule:line-length

      - name: Create the Pull Request
        if: github.event_name != 'pull_request'
        id: cpr
        # yamllint disable-line rule:line-length
        # nosemgrep: yaml.github-actions.security.third-party-action-not-pinned-to-commit-sha.third-party-action-not-pinned-to-commit-sha
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.MERGIFY_CI_BOT_PAT }}
          author: mergify-ci-bot <mergify-ci-bot@users.noreply.github.com>
          labels: ${{ steps.update.outputs.labels }}
          title: "chore(docker): image security scanning report"
          body: >
            This is the docker image security scanning report

            ${{ steps.update.outputs.report }}
          commit-message: >
            chore(docker): image security scanning report

            This is the docker image security scanning report

            ${{ steps.update.outputs.report }}
          branch: trivy/daily-report
          base: main

      - name: Check outputs
        if: github.event_name != 'pull_request'
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"

      - name: Report Status
        if: failure() && github.event_name != 'pull_request'
        # yamllint disable-line rule:line-length
        # nosemgrep: yaml.github-actions.security.third-party-action-not-pinned-to-commit-sha.third-party-action-not-pinned-to-commit-sha
        uses: Mergifyio/gha-slack-notification@main
        with:
          message: Docker image security scan
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WORKFLOWS_WEBHOOK_URL }}
