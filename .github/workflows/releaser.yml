# Release command:
#
#  gh workflow run Releaser
#
name: Releaser
permissions: write-all
on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "don't push thing"
        required: false
        default: false
jobs:
  releaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3
        with:
          ssh-key: "${{ secrets.DEPLOY_BOT_SSH_PRIVATE_KEY }}"
          fetch-depth: 0

      - name: Setup Python 🔧
        uses: actions/setup-python@v3
        with:
          python-version: 3.10.4

      - name: Setup dependencies 🔧
        run: |
          set -e
          set -o pipefail

          pip install reno

          curl -L https://github.com/jgm/pandoc/releases/download/2.14.2/pandoc-2.14.2-linux-amd64.tar.gz \
            | tar -xzf - --strip-components=2 pandoc-2.14.2/bin/pandoc

      - name: Build release notes 📝
        id: relnote
        run: |
          set -e
          set -o pipefail

          cd mergify-engine

          git fetch --tag
          VERSION=$(reno -q semver-next)
          git tag ${VERSION}

          echo "✂┅┅┅"
          reno -q report --title '' --no-show-source | pandoc -t markdown | sed -e '/^\.\./,+1d' -e '1,4d'
          echo "✂┅┅┅"

          cd -
          git tag ${VERSION}
          echo "::set-output name=VERSION::$VERSION"

      - name: Push git tag 🏎️
        if: ${{ !github.event.inputs.dry_run }}
        run: |
          git submodule set-url mergify-engine git@github.com:Mergifyio/mergify-engine.git
          git push origin ${{ steps.relnote.outputs.VERSION }}
          cd mergify-engine
          git push origin ${{ steps.relnote.outputs.VERSION }}
