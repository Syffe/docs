init_config:

instances:
  - host: <YOUR HOSTNAME>
    port: <YOUR PORT>
    username: <YOUR USERNAME>
    password: <YOUR PASSWORD>
    dbname: <YOUR DBNAME>
    dbm: true
    ssl: True
    custom_queries:
      - metric_prefix: engine.db
        query: "SELECT count(*) FROM \"github_user\""
        columns:
          - name: users.count
            type: gauge
      - metric_prefix: engine.db
        query: >
          SELECT
            SUM(CASE WHEN log_embedding IS NULL THEN 1 ELSE 0 END) AS log_embedding_need_update
            SUM(CASE WHEN embedded_log IS NULL THEN 1 ELSE 0 END) AS embedded_log_need_update,
            SUM(CASE WHEN embedded_log_error_title IS NULL THEN 1 ELSE 0 END)
              AS embedded_log_error_title_need_update,
            SUM(CASE WHEN neighbours_computed_at IS NULL THEN 1 ELSE 0 END) AS neighbours_need_update,
          FROM gha_workflow_job
            JOIN github_repository
              ON gha_workflow_job.repository_id = github_repository.id
            JOIN github_account
              ON github_repository.owner_id = github_account.id
          WHERE
              gha_workflow_job.conclusion = 'FAILURE'
              AND gha_workflow_job.failed_step_number is not NULL
              AND github_account.login in (<LOG_EMBEDDER_MONITORED_ACCOUNTS>)
          ;
        columns:
          - name: workflow-job.log-embedding-need-update
            type: gauge
          - name: workflow-job.embedded-log-need-update
            type: gauge
          - name: workflow-job.embedded-error-title-log-need-update
            type: gauge
          - name: workflow-job.neighbour-need-update
            type: gauge
