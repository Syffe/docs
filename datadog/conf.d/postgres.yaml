init_config:

instances:
  - host: <YOUR HOSTNAME>
    port: <YOUR PORT>
    username: <YOUR USERNAME>
    password: <YOUR PASSWORD>
    dbname: <YOUR DBNAME>
    dbm: true
    ssl: allow
    custom_queries:
      - metric_prefix: engine.db
        query: SELECT count(*) FROM github_user
        columns:
          - name: users.count
            type: gauge
      - metric_prefix: engine.db
        query: >
          SELECT
            count(*),
            log_embedding IS NULL AS log_embedding_need_update,
            embedded_log IS NULL  AS embedded_log_need_update,
            ci_issue_id IS NULL AS not_linked_to_ci_issue
          FROM gha_workflow_job
            JOIN github_repository
              ON gha_workflow_job.repository_id = github_repository.id
            JOIN github_account
              ON github_repository.owner_id = github_account.id
          WHERE
              gha_workflow_job.conclusion = 'FAILURE'
              AND gha_workflow_job.failed_step_number is not NULL
              AND log_status not in ('GONE', 'ERROR')
              AND github_account.login in (<LOG_EMBEDDER_MONITORED_ACCOUNTS>)
          GROUP BY
            log_embedding IS NULL,
            embedded_log IS NULL,
            ci_issue_id IS NULL
          ;
        columns:
          - name: workflow-job.count
            type: gauge
          - name: log-embedding-need-update
            type: tag
          - name: embedded-log-need-update
            type: tag
          - name: not-linked-to-ci-issue
            type: tag
      - metric_prefix: engine.db
        query: SELECT count(*), name IS NULL FROM ci_issue group by name IS NULL ;
        columns:
          - name: ci-issue.count
            type: gauge
          - name: name-is-null
            type: tag
