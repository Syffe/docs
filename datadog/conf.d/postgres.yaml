init_config:

instances:
  - host: <YOUR HOSTNAME>
    port: <YOUR PORT>
    username: <YOUR USERNAME>
    password: <YOUR PASSWORD>
    dbname: <YOUR DBNAME>
    dbm: true
    ssl: allow
    custom_queries:
      - metric_prefix: engine.db
        query: SELECT count(*) FROM github_user
        columns:
          - name: users.count
            type: gauge
      - metric_prefix: engine.db
        query: >
          SELECT
            count(*),
            log_status,
            log_embedding_status,
            log_metadata_extracting_status,
            EXISTS(
              SELECT
                1
              FROM
                gha_workflow_job_log_metadata
              WHERE
                workflow_job_id = gha_workflow_job.id
            ) has_metadata,
            EXISTS(
              SELECT
                1
              FROM
                gha_workflow_job_log_metadata
                JOIN ci_issue_gpt ON ci_issue_gpt.id = gha_workflow_job_log_metadata.ci_issue_id
              WHERE
                workflow_job_id = gha_workflow_job.id
            ) has_ci_issue_gpt
          FROM
            gha_workflow_job
            JOIN github_repository ON gha_workflow_job.repository_id = github_repository.id
            JOIN github_account ON github_repository.owner_id = github_account.id
          WHERE
            gha_workflow_job.conclusion = 'FAILURE'
            AND github_account.login in (< LOG_EMBEDDER_MONITORED_ACCOUNTS >)
          GROUP BY
            log_embedding_status,
            log_status,
            log_metadata_extracting_status,
            has_metadata,
            has_ci_issue_gpt;
        columns:
          - name: workflow-job.count
            type: gauge
          - name: log-status
            type: tag
          - name: log-embedding-status
            type: tag
          - name: log-metadata-extracting-status
            type: tag
          - name: has-metadata
            type: tag
          - name: has-ci-issue-gpt
            type: tag
